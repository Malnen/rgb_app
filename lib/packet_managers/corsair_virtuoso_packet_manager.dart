import 'dart:ffi';
import 'dart:typed_data';

import 'package:rgb_app/devices/corsair_virtuoso/corsair_virtuoso.dart';
import 'package:rgb_app/extensions/uint_8_list_blob_conversion_extension.dart';
import 'package:rgb_app/packet_managers/packet_manager.dart';
import 'package:ffi/ffi.dart' show calloc;


class CorsairVirtuosoPacketManager extends PacketManager {
  final CorsairVirtuoso corsairVirtuoso;

  CorsairVirtuosoPacketManager(this.corsairVirtuoso);

  @override
  void fill() {
    corsairVirtuoso.dataPkt1 = Uint8List.fromList([
      0x1b,
      0x00,
      0xa0,
      0xf9,
      0x46,
      0x19,
      0x8c,
      0xdd,
      0xff,
      0xff,
      0x00,
      0x00,
      0x00,
      0x00,
      0x09,
      0x00,
      0x01,
      0x01,
      0x00,
      0x10,
      0x82,
      0x01,
      0x40,
      0x00,
      0x00,
      0x00,
      0x01,
      0x01,
      0x06,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00
    ]);

    corsairVirtuoso.dataPkt2 = Uint8List.fromList([
      0x1b,
      0x00,
      0xa0,
      0xc2,
      0x5c,
      0x15,
      0x8c,
      0xdd,
      0xff,
      0xff,
      0x00,
      0x00,
      0x00,
      0x00,
      0x09,
      0x00,
      0x01,
      0x01,
      0x00,
      0x10,
      0x82,
      0x01,
      0x40,
      0x00,
      0x00,
      0x00,
      0x01,
      0x01,
      0x06,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00
    ]);

    corsairVirtuoso.rPkt1 = Uint8List.fromList([
      0x1b,
      0x00,
      0x50,
      0xc0,
      0x5a,
      0x1f,
      0x8c,
      0xdd,
      0xff,
      0xff,
      0x00,
      0x00,
      0x00,
      0x00,
      0x09,
      0x00,
      0x00,
      0x01,
      0x00,
      0x10,
      0x00,
      0x02,
      0x01,
      0x40,
      0x00,
      0x00,
      0x02,
      0x09,
      0x06,
      0x00,
      0x09,
      0x00,
      0x00,
      0x00,
      0xff,
      0xff,
      0xff,
      0x00,
      0xbe,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00
    ]);

    corsairVirtuoso.lPkt1 = Uint8List.fromList([
      0x1b,
      0x00,
      0x20,
      0x45,
      0x1f,
      0x1f,
      0x8c,
      0xdd,
      0xff,
      0xff,
      0x00,
      0x00,
      0x00,
      0x00,
      0x09,
      0x00,
      0x00,
      0x01,
      0x00,
      0x10,
      0x00,
      0x02,
      0x01,
      0x40,
      0x00,
      0x00,
      0x02,
      0x09,
      0x06,
      0x00,
      0x09,
      0x00,
      0x00,
      0x00,
      0xff,
      0x00,
      0xff,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00
    ]);
  }

  @override
  void sendData() {
    corsairVirtuoso.libusb.libusb_interrupt_transfer(
      corsairVirtuoso.devHandle,
      0x02,
      corsairVirtuoso.rPkt1.allocatePointer(),
      64,
      calloc<Int32>(),
      1000,
    );
    corsairVirtuoso.libusb.libusb_interrupt_transfer(
      corsairVirtuoso.devHandle,
      0x82,
      corsairVirtuoso.dataPkt1.allocatePointer(),
      64,
      calloc<Int32>(),
      1000,
    );
    corsairVirtuoso.libusb.libusb_interrupt_transfer(
      corsairVirtuoso.devHandle,
      0x02,
      corsairVirtuoso.lPkt1.allocatePointer(),
      64,
      calloc<Int32>(),
      1000,
    );
    corsairVirtuoso.libusb.libusb_interrupt_transfer(
      corsairVirtuoso.devHandle,
      0x82,
      corsairVirtuoso.dataPkt2.allocatePointer(),
      64,
      calloc<Int32>(),
      1000,
    );
  }
}
