import 'dart:ffi';
import 'dart:io';
import 'dart:typed_data';

import 'package:rgb_app/devices/corsair_virtuoso/corsair_virtuoso.dart';
import 'package:rgb_app/extensions/uint_8_list_blob_conversion_extension.dart';
import 'package:rgb_app/packet_managers/packet_manager.dart';
import 'package:ffi/ffi.dart' show calloc;

class CorsairVirtuosoPacketManager extends PacketManager {
  final CorsairVirtuoso corsairVirtuoso;

  CorsairVirtuosoPacketManager(this.corsairVirtuoso);

  @override
  void fill() {
    corsairVirtuoso.dataPkt1 = Uint8List.fromList(<int>[
      0x1b,
      0x00,
      0x20,
      0x03,
      0x72,
      0x20,
      0x8c,
      0xdd,
      0xff,
      0xff,
      0x00,
      0x00,
      0x00,
      0x00,
      0x09,
      0x00,
      0x01,
      0x01,
      0x00,
      0x0a,
      0x00,
      0x82,
      0x01,
      0x40,
      0x00,
      0x00,
      0x00,
      0x01,
      0x01,
      0x06,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00
    ]);

    corsairVirtuoso.dataPkt2 = Uint8List.fromList(<int>[
      0x1b,
      0x00,
      0x20,
      0x03,
      0x72,
      0x20,
      0x8c,
      0xdd,
      0xff,
      0xff,
      0x00,
      0x00,
      0x00,
      0x00,
      0x09,
      0x00,
      0x01,
      0x01,
      0x00,
      0x0a,
      0x00,
      0x82,
      0x01,
      0x40,
      0x00,
      0x00,
      0x00,
      0x01,
      0x01,
      0x06,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00
    ]);

    corsairVirtuoso.rPkt1 = Uint8List.fromList(<int>[
      0x1b,
      0x00,
      0x60,
      0x45,
      0x32,
      0x22,
      0x8c,
      0xdd,
      0xff,
      0xff,
      0x00,
      0x00,
      0x00,
      0x00,
      0x09,
      0x00,
      0x00,
      0x01,
      0x00,
      0x0a,
      0x00,
      0x02,
      0x01,
      0x40,
      0x00,
      0x00,
      0x02,
      0x09,
      0x06,
      0x00,
      0x09,
      0x00,
      0x00,
      0x00,
      0xff,
      0x00,
      0xff,
      0x00,
      0x80,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00
    ]);

    corsairVirtuoso.lPkt1 = Uint8List.fromList(<int>[
      0x1b,
      0x00,
      0x20,
      0x45,
      0x1f,
      0x1f,
      0x8c,
      0xdd,
      0xff,
      0xff,
      0x00,
      0x00,
      0x00,
      0x00,
      0x09,
      0x00,
      0x00,
      0x01,
      0x00,
      0x10,
      0x00,
      0x02,
      0x01,
      0x40,
      0x00,
      0x00,
      0x02,
      0x09,
      0x06,
      0x00,
      0x09,
      0x00,
      0x00,
      0x00,
      0xff,
      0x00,
      0xff,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00,
      0x00
    ]);
  }

  @override
  void sendData() {
    for (int i = 0; i < 256; i++) {
      print('====================================');
      print(i);
      final int interupt = corsairVirtuoso.libusb.libusb_interrupt_transfer(
        corsairVirtuoso.devHandle,
        i,
        corsairVirtuoso.rPkt1.allocatePointer(),
        64,
        calloc<Int32>(),
        1000,
      );
      print('interupt $interupt');
      final int bulk = corsairVirtuoso.libusb.libusb_bulk_transfer(
        corsairVirtuoso.devHandle,
        i,
        corsairVirtuoso.lPkt1.allocatePointer(),
        64,
        calloc<Int32>(),
        1000,
      );
      print('bulk $bulk');
      sleep(Duration(milliseconds: 50));
      if(interupt == 0 || bulk == 0){
        print('mamy to widzowie');
        break;
      }
    }
    print('====================================');
  }
}
